!function(a){"use strict";var b=function(a){var b,d;return b=function(){d=!1},function(){var e;d||(d=!0,e=c(arguments),e.unshift(b),a.apply(this,e))}},c=function(a){var b;return b=Array.prototype.slice.call(a)},d=function(a,b){return a.bind?a.bind(b):function(){a.apply(b,arguments)}},e=function(){var b;return b=a("<div></div>").css(["color"]).color,"undefined"!=typeof b?function(a,b){return a.css(b)}:function(b,c){var d;return d={},a.each(c,function(a,c){d[c]=b.css(c)}),d}}(),f=function(a){return a},g=function(a){var b={};return function(c,d){b[c]?d(b[c]):a.call(this,c,function(a){b[c]=(b[c]||[]).concat(a),d.apply(null,arguments)})}},h=function(a,b){var c,d;if(a.indexOf)return-1!=a.indexOf(b);for(c=0,d=a.length;d>c;c++)if(a[c]===b)return!0;return!1},i=function(){function c(b,c){var e,f,g;f=i.clone(),this.el=b.get(0),this.$el=b,e=k(this.$el),g=this.el===document.activeElement,this.$el.wrap(e).before(f),g&&this.el.focus(),this.listView=new j(f,this),this.strategies=c,this.$el.on("keyup",d(this.onKeyup,this)),this.$el.on("keydown",d(this.listView.onKeydown,this.listView)),a(document).on("click",d(function(a){a.originalEvent&&!a.originalEvent.keepTextCompleteDropdown&&this.listView.deactivate()},this))}var f,g,h,i;f={wrapper:'<div class="textcomplete-wrapper"></div>',list:'<div class="dropdown-menu"><ul class="format"></ul><ul class="autocomplete"></ul></div>'},g={wrapper:{position:"relative"},list:{position:"absolute",top:0,left:0,zIndex:"100",display:"none"}},h=a(f.wrapper).css(g.wrapper),i=a(f.list).css(g.list),a.extend(c.prototype,{renderList:function(a,b,c){this.listView.clear(),this.lastData=c,c.autocomplete=this.filterData(a,c.autocomplete),(c.autocomplete.length||c.format.length)&&(this.listView.setPosition(this.getCaretPosition(a,b,c.autocomplete)),this.listView.shown||(this.listView.clear().activate(),this.listView.strategy=this.strategy),this.listView.render(c)),this.listView.data.autocomplete.length||this.listView.data.format.length||!this.listView.shown||this.listView.deactivate()},searchCallbackFactory:function(a,b){var c=this,d=c.getTextFromHeadToCaret();return function(e,f){c.renderList(a,d,e),f||(b(),c.clearAtNext=!0,c.onKeyup())}},onKeyup:function(a,b){var c,d;if(c=this.extractSearchQuery(this.getTextFromHeadToCaret()),c.length){if(d=c[1],!b&&this.term===d)return;this.search(c)}else this.term=null,this.listView.deactivate()},onSelect:function(a){var b,c,d;b=this.getTextFromHeadToCaret(),c=this.el.value.substring(this.el.selectionEnd),b=this.strategy.replace(b,a),d=b+c,this.el.value=d,this.el.focus(),this.strategy.change(d),this.el.selectionStart=this.el.selectionEnd=b.length,this.onKeyup(null,!0)},getCommonPart:function(a,b){var c,d;for(c=Math.min(a.length,b.length);c>=0&&(d=b.substring(0,c),a.toLowerCase().lastIndexOf(d.toLowerCase())!==a.length-d.length);)c--;return b.substring(0,c)},getCaretPosition:function(b,c,d){function f(a){if(0===a.length)return"";for(var b=a[0],c=b.length,d=1;d<a.length&&c>0;d++){for(var e=a[d],f=0,g=Math.min(e.length,c);++f<g&&e.charAt(f).toLowerCase()==b.charAt(f).toLowerCase(););c=f}return b.substring(0,c)}var g,h,i,j,k,c;g=["border-width","font-family","font-size","font-style","font-variant","font-weight","height","letter-spacing","word-spacing","line-height","text-decoration","text-align","width","padding-top","padding-right","padding-bottom","padding-left","margin-top","margin-right","margin-bottom","margin-left"],h=a.extend({position:"absolute",overflow:"auto","white-space":"pre-wrap",top:0,left:-9999},e(this.$el,g));var l=f(d),m=this.getCommonPart(c,l);return c.length>=m.length&&(c=c.substring(0,c.length-m.length)),i=a("<div></div>").css(h).text(c),j=a("<span></span>").text("&nbsp;").appendTo(i),this.$el.before(i),k=j.position(),k.top+=j.height()-this.$el.scrollTop(),i.remove(),k},getTextFromHeadToCaret:function(){var a,b,c;return b=this.el.selectionEnd,"number"==typeof b?a=this.el.value.substring(0,b):document.selection&&(c=this.el.createTextRange(),c.moveStart("character",0),c.moveEnd("textedit"),a=c.text),a},filterData:function(a,b){var c=this.getTextFromHeadToCaret(),d=c.substring(a.length,c.length);if(d.lenght>0){for(var e=[],f=0;f<b.length;f++)b[f].substring(0,d.lenght)===d&&e.push(b[f]);return e}return b},extractSearchQuery:function(a){var b,c,d,e;for(b=0,c=this.strategies.length;c>b;b++)if(d=this.strategies[b],d.ac=this,e=a.match(d.match))return[d,e[d.index]];return[]},search:function(a){var b;return this.strategy=a[0],b=a[1],this.searchOnline(b)},searchOnline:b(function(a,b){this.term=b,this.strategy.search(b,this.searchCallbackFactory(b,a))})});var k=function(a){return h.clone().css("display",a.css("display"))};return c}(),j=function(){function b(a,b){this.data={autocomplete:[],format:[]},this.$el=a,this.index=0,this.completer=b,this.$el.on("click","li.textcomplete-item",d(this.onClick,this)),this.$el.on("change","select",d(this.onChange,this))}return a.extend(b.prototype,{shown:!1,render:function(a){var b,c,d,e,f,g=this.strategy.maxCount;if(a.autocomplete.length>this.strategy.maxCount&&g--,this.data.format=a.format,a.format.length){for(b="",c=0,d=a.format.length;d>c;c++)f=a.format[c],b+='<li class="textcomplete-item textcomplete-format">',b+=f,b+="</li>";this.$el.find(".format").append(b)}for(b="",c=0,d=a.autocomplete.length;d>c&&(f=a.autocomplete[c],h(this.data.autocomplete,f)||(e=this.data.autocomplete.length,this.data.autocomplete.push(f),b+='<li class="textcomplete-item" data-index="'+e+'"><a>',b+=this.strategy.template(f),b+="</a></li>",this.data.autocomplete.length!==g));c++);if(this.displayCount=this.data.autocomplete.length,a.autocomplete.length>g){for(b+='<li class="textcomplete-more" data.autocomplete-index="'+g+'">',b+="<select>",b+='<option value="more">...</option>',c=g,d=a.autocomplete.length;d>c;c++)f=a.autocomplete[c],h(this.data.autocomplete,f)||(e=this.data.autocomplete.length,this.data.autocomplete.push(f),b+='<option data-index="'+e+'" value="'+e+'">'+f+"</option>");b+='</select">',b+="</li>",this.displayCount++}this.$el.find(".autocomplete").append(b),0===this.data.autocomplete.length&&0===a.format.length?this.deactivate():this.data.autocomplete.length?this.activateIndexedItem():this.reposition()},clear:function(){return this.data.autocomplete=[],this.data.format=[],this.$el.find(".autocomplete").html(""),this.$el.find(".format").html(""),this.index=0,this},activateIndexedItem:function(){this.$el.find(".active").removeClass("active"),this.getActiveItem().addClass("active"),this.reposition()},getActiveItem:function(){return a(this.$el.find(".autocomplete").children().get(this.index))},activate:function(){return this.shown||(this.$el.show(),this.shown=!0),this},deactivate:function(){return this.shown&&(this.$el.hide(),this.shown=!1,this.data={autocomplete:[],format:[]},this.index=null),this},setPosition:function(a){return this.$el.css(a),this},select:function(a){this.completer.onSelect(this.data.autocomplete[a]),this.deactivate()},reposition:function(){var b=a(".textcomplete-wrapper"),c=this.$el.offset().left+this.$el.outerWidth(),d=(this.$el.offset().top+this.$el.outerHeight(),b.offset().left+b.outerWidth());b.offset().left+b.outerWidth();if(c>d){var e=c-d,f=parseInt(this.$el.css("left").replace("px",""),10);this.$el.css("left",f-e)}},onKeydown:function(a){if(this.shown)if(27===a.keyCode)this.deactivate();else if(38===a.keyCode)a.preventDefault(),0===this.index?this.index=this.displayCount-1:this.index-=1,this.activateIndexedItem();else if(40===a.keyCode)a.preventDefault(),this.index===this.displayCount-1?this.index=0:this.index+=1,this.activateIndexedItem();else if(13===a.keyCode||9===a.keyCode){var b=this.getActiveItem(),c=parseInt(b.data("index"));b.hasClass("textcomplete-more")?b.find("select").focus():(a.preventDefault(),this.select(c))}},onClick:function(b){var c=a(b.target);b.originalEvent.keepTextCompleteDropdown=!0,c.hasClass("textcomplete-item")||(c=c.parents("li.textcomplete-item")),this.select(parseInt(c.data("index")))},onChange:function(b){var c=a(b.target);this.select(parseInt(c.val()))}}),b}();a.fn.textcomplete=function(a){var b,c,d;for(b=0,c=a.length;c>b;b++)d=a[b],d.template||(d.template=f),null==d.index&&(d.index=2),d.cache&&(d.search=g(d.search)),d.maxCount||(d.maxCount=10);return new i(this,a),this}}(window.jQuery||window.Zepto);