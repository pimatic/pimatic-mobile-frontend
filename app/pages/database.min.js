(function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}};a=pimatic.tryCatch,$(document).on("pagecreate","#database-page",a(function(c){var d,e,f;d=function(){function c(){this.fixProblem=b(this.fixProblem,this),this.updateDeviceAttribute=b(this.updateDeviceAttribute,this),this.deleteDeviceAttribute=b(this.deleteDeviceAttribute,this),this.hasPermission=pimatic.hasPermission,this.updateFromJs({problems:[],deviceAttributes:[]}),this.updateListView=ko.computed(function(a){return function(){return a.problems(),pimatic["try"](function(){return $("#log-messages").listview("refresh")})}}(this))}return c.mapping={$default:"ignore",problems:{$key:"id",$itemOptions:{$handler:"copy"}},deviceAttributes:{$key:"id",$itemOptions:{$default:"copy",count:"observe",interval:"observe",expire:"observe"}}},c.prototype.updateFromJs=function(a){return ko.mapper.fromJS(a,c.mapping,this)},c.prototype.deleteDeviceAttribute=function(b){return pimatic.client.rest.deleteDeviceAttribute({id:b.id}).done(a(function(a){return function(c){c.success&&a.problems.remove(function(a){return a.id===b.id})}}(this))).fail(ajaxAlertFail)},c.prototype.updateDeviceAttribute=function(b){return pimatic.client.rest.updateDeviceAttribute({id:b.id}).done(a(function(a){return function(c){c.success&&a.problems.remove(function(a){return a.id===b.id})}}(this))).fail(ajaxAlertFail)},c.prototype.fixProblem=function(a){switch(a.action){case"delete":return this.deleteDeviceAttribute(a);case"update":return this.updateDeviceAttribute(a)}},c.prototype.checkDatabase=function(){var b;return b=function(b){return function(){return null==b.loadProblemsAjax?(pimatic.loading("databasecheck","show",{text:__("Checking Database")}),pimatic.client.rest.checkDatabase({},{timeout:6e4,global:!1}).always(function(){return pimatic.loading("databasecheck","hide")}).done(a(function(a){b.loadProblemsAjax=null,a.success&&b.updateFromJs({problems:a.problems})})).fail(ajaxAlertFail)):void 0}}(this),null==this.loadProblemsAjax?b():this.loadProblemsAjax.done(function(a){return function(){return b()}}(this))},c.prototype.querydeviceAttributeInfo=function(){var b;return b=function(b){return function(){return null==b.loadDAInfoAjax?(pimatic.loading("deviceattributeinfo","show",{text:__("Querying attribute info")}),pimatic.client.rest.queryDeviceAttributeEventsInfo({},{timeout:6e4,global:!1}).always(function(){return pimatic.loading("deviceattributeinfo","hide")}).done(a(function(a){var c,d,e,f;if(b.loadDAInfoAjax=null,a.success){for(f=a.deviceAttributes,d=0,e=f.length;e>d;d++)c=f[d],c.count="?";b.updateFromJs({deviceAttributes:a.deviceAttributes}),b.querydeviceAttributeCounts()}})).fail(ajaxAlertFail)):void 0}}(this),null==this.loadDAInfoAjax?b():this.loadDAInfoAjax.done(function(a){return function(){return b()}}(this))},c.prototype.querydeviceAttributeCounts=function(){var b;return b=function(b){return function(){return null==b.loadCountsAjax?(pimatic.loading("deviceattributeCounts","show",{text:__("Querying counts")}),pimatic.client.rest.queryDeviceAttributeEventsCounts({},{timeout:6e4,global:!1}).always(function(){return pimatic.loading("deviceattributeCounts","hide")}).done(a(function(a){var c,d,e,f,g,h,i,j,k,l,m;if(b.loadCountsAjax=null,a.success){for(k=a.counts,e=0,h=k.length;h>e;e++)for(c=k[e],l=b.deviceAttributes(),f=0,i=l.length;i>f;f++)d=l[f],d.id===c.deviceAttributeId&&d.count(c.count);for(m=b.deviceAttributes(),g=0,j=m.length;j>g;g++)d=m[g],"?"===d.count()&&d.count(0)}})).fail(ajaxAlertFail)):void 0}}(this),null==this.loadCountsAjax?b():this.loadCountsAjax.done(function(a){return function(){return b()}}(this))},c}();try{pimatic.pages.database=e=new d,ko.applyBindings(e,$("#database-page")[0])}catch(g){f=g,TraceKit.report(f)}})),$(document).on("pagebeforeshow","#database-page",a(function(a){var b,c;try{return b=pimatic.pages.database,b.checkDatabase(),b.querydeviceAttributeInfo()}catch(d){return c=d,TraceKit.report(c)}}))}).call(this);