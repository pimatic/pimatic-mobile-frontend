(function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};a=Array.prototype.concat,LazyLoad.js(a.apply(scripts.textcomplete)),$(document).on("pagecreate","#edit-rule-page",function(a){var d,e,f;if(null==pimatic.pages.editRule){d=function(){function a(a){this.ruleView=a,this.elementOptionsText=b(this.elementOptionsText,this),this.remove=b(this.remove,this),this.cancel=b(this.cancel,this),this.ok=b(this.ok,this),this.showDefaultSelection=b(this.showDefaultSelection,this),this.getElements=b(this.getElements,this),this.selectPredicate=b(this.selectPredicate,this),this.keypress=b(this.keypress,this),this.setInputValue=b(this.setInputValue,this),this.computedPredicateToken=ko.computed(function(a){return function(){var b,c,d,e,f;for(c="",a.justTrigger()&&(c+="trigger: "),f=a.elements(),d=0,e=f.length;e>d;d++)b=f[d],c+=b.match();return c}}(this)),this.computedToken=ko.computed(function(a){return function(){var b,c,d,e,f;if(c=a.computedPredicateToken(),a.forEnabled())for(f=a.forElements(),d=0,e=f.length;e>d;d++)b=f[d],c+=b.match();return c}}(this)),this.computedToken.subscribe(this.setInputValue),this.inputValue.subscribe(function(a){return function(b){return a.dontUpdate?void 0:(a.disableElementsInput(!0),clearTimeout(a._getElments),a._getElments=setTimeout(function(){return a.getElements(b,null,"input changed")},2e3))}}(this))}return a.prototype.visible=ko.observable(!1),a.prototype.presets=ko.observable([]),a.prototype.elements=ko.observable([]),a.prototype.forElements=ko.observable([]),a.prototype.presetsVisible=ko.observable(!0),a.prototype.elementsVisible=ko.observable(!0),a.prototype.forElementsVisible=ko.observable(!0),a.prototype.forEnabled=ko.observable(!1),a.prototype.parentOp=null,a.prototype.side="left",a.prototype.errors=ko.observable(!0),a.prototype.inputValue=ko.observable(!0),a.prototype.disablePredicateInput=ko.observable(!1),a.prototype.disableElementsInput=ko.observable(!1),a.prototype.justTrigger=ko.observable(!1),a.prototype.canRemove=ko.observable(!1),a.prototype.setInputValue=function(a){return this.dontUpdate=!0,this.inputValue(a),this.dontUpdate=!1},a.prototype.keypress=function(a,b){return 13===b.keyCode?(this.parse(this.inputValue(),!0),!1):!0},a.prototype.parse=function(a){return pimatic.client.rest.getRuleConditionHints({conditionInput:a}).done(function(a){return function(b){return b.success&&null!=b.hints.tree?(b.hints.tree.parent=a.parentOp,a.updateTree(b.hints.tree),a.visible(!1)):(a.errors(b.hints.errors),swal("Oops...",__(b.hints.errors[0]),"error"))}}(this))},a.prototype.refreshPresets=function(){return pimatic.client.rest.getPredicatePresets({}).done(function(a){return function(b){return b.success&&null!=b.presets?a.presets(b.presets):void 0}}(this))},a.prototype.updateTree=function(a){if(null==this.parentOp)return this.ruleView.tree(a);if(!this.side)throw new Error("illegal side: ",this.side);return this.parentOp[this.side]=a,this.ruleView.tree.valueHasMutated()},a.prototype.selectPredicate=function(a){return this.setInputValue(a.input),this.getElements(a.input,a.predicateProviderClass,"selectPredicate")},a.prototype.getElements=function(a,b,c){return 0===this.inputValue().length?this.showDefaultSelection():(this.disableElementsInput(!0),this.disablePredicateInput(!0),pimatic.client.rest.getPredicateInfo({input:a,predicateProviderClass:b}).done(function(a){return function(b){var c,d;return b.success?(null!=b.result.predicate&&(a.justTrigger(b.result.predicate.justTrigger),c=b.result.elements,0===a.elements().length&&null==c&&(c=[{match:b.result.predicate.token,type:"text"}]),0===b.result.errors.length&&null!=c&&a.showElementSelection(c,b.result.forElements,null!=(null!=(d=b.result.predicate)?d["for"]:void 0))),a.errors(b.result.errors||[])):void 0}}(this)).always(function(a){return function(){return a.disableElementsInput(!1),a.disablePredicateInput(!1)}}(this)))},a.prototype.showDefaultSelection=function(){return this.presetsVisible(!0),this.elementsVisible(!1),this.forElementsVisible(!1),0===this.presets().length&&this.refreshPresets(),this.disableElementsInput(!1),this.disablePredicateInput(!1)},a.prototype.showElementSelection=function(a,b,d){var e,f,g,h,i,j,k,l,m,n,o;if(this.presetsVisible(!1),this.elementsVisible(!0),this.forEnabled(d),i=function(a){var b,c,d;for(c=0,d=a.length;d>c;c++)b=a[c],ko.isObservable(b.match)||(b.wildcardMatch&&"text"!==b.type?b.match=ko.observable(b.wildcard):b.match=ko.observable(b.match));return a},null!=this.eleSubscriptions)for(o=this.eleSubscriptions,k=0,m=o.length;m>k;k++)f=o[k],f.dispose();for(this.eleSubscriptions=[],i(a),h=!1,j=function(b){return function(d,e){return b.eleSubscriptions.push(e.match.subscribe(function(e){var f,g,i,j;if(!h){for(h=!0,a=b.elements(),g=d+1;g<a.length;)f=a[g],null!=f.wildcard&&(null!=f.options&&(j=f.wildcard,c.call(f.options,j)<0&&f.options.unshift(f.wildcard)),f.match(f.wildcard)),g++;return h=!1,clearTimeout(b._getElments),i="select"===a[d].type?100:2e3,b._getElments=setTimeout(function(){return b.getElements(b.computedToken(),null,"element changed")},i)}}))}}(this),g=l=0,n=a.length;n>l;g=++l)e=a[g],j(g,e);return this.elements(a),null!=b?this.forElements(i(b)):this.forElements([]),this.forElementsVisible(null!=b)},a.prototype.showEmpty=function(a){var b;return this.side="right",this.parentOp=a,this.visible(!0),this.setInputValue(""),this.refreshPresets(),this.showDefaultSelection(),this.justTrigger(!1),this.canRemove(!1),b="ontouchstart"in window||navigator.msMaxTouchPoints,b?void 0:$("#rule-condition-input").focus()},a.prototype.editPredicate=function(a){var b;return this.side=(null!=(b=a.parent)?b.left:void 0)===a?"left":"right",this.parentOp=a.parent,this.visible(!0),this.canRemove(!0),this.setInputValue(this.ruleView.predicateToString(a.predicate)),this.getElements(this.inputValue())},a.prototype.ok=function(){return this.parse(this.inputValue(),!0)},a.prototype.cancel=function(){return null!=this.parentOp&&null===this.parentOp[this.side]&&(null!=this.parentOp.parent?("left"===this.side?this.parentOp.parent.left===this.parentOp?(this.parentOp.parent.left=this.parentOp.right,this.parentOp.parent.left.parent=this.parentOp.parent):this.parentOp.parent.right===this.parentOp&&(this.parentOp.parent.right=this.parentOp.right,this.parentOp.parent.right.parent=this.parentOp.parent):this.parentOp.parent.left===this.parentOp?(this.parentOp.parent.left=this.parentOp.left,this.parentOp.parent.left.parent=this.parentOp.parent):this.parentOp.parent.right===this.parentOp&&(this.parentOp.parent.right=this.parentOp.left,this.parentOp.parent.right.parent=this.parentOp.parent),this.ruleView.tree.valueHasMutated()):"left"===this.side?(this.parentOp.right.parent=void 0,this.ruleView.tree(this.parentOp.right)):(this.parentOp.left.parent=void 0,this.ruleView.tree(this.parentOp.left))),this.visible(!1)},a.prototype.remove=function(){return null!=this.parentOp?(null!=this.parentOp.parent?"left"===this.side?this.parentOp.parent.left===this.parentOp?(this.parentOp.parent.left=this.parentOp.right,this.parentOp.parent.left.parent=this.parentOp.parent):this.parentOp.parent.right===this.parentOp&&(this.parentOp.parent.right=this.parentOp.right,this.parentOp.parent.right.parent=this.parentOp.parent):this.parentOp.parent.left===this.parentOp?(this.parentOp.parent.left=this.parentOp.left,this.parentOp.parent.left.parent=this.parentOp.parent):this.parentOp.parent.right===this.parentOp&&(this.parentOp.parent.right=this.parentOp.left,this.parentOp.parent.right.parent=this.parentOp.parent):"left"===this.side?(this.parentOp.right.parent=void 0,this.ruleView.tree(this.parentOp.right)):(this.parentOp.left.parent=void 0,this.ruleView.tree(this.parentOp.left)),this.ruleView.tree.valueHasMutated()):this.ruleView.tree(null),this.visible(!1)},a.prototype.elementOptionsText=function(a){return a.replace(/^\{(.*)\}$/,"Choose $1...")},a}(),e=function(){function a(){this.saveEditMode=b(this.saveEditMode,this),this.setGuiMode=b(this.setGuiMode,this),this.setTextMode=b(this.setTextMode,this),this.addOr=b(this.addOr,this),this.addAnd=b(this.addAnd,this),this.editPredicate=b(this.editPredicate,this),this.addCondition=b(this.addCondition,this),this.ruleAsText=ko.computed(function(a){return function(){return"text"===a.editMode()?"when "+a.ruleCondition()+" then "+a.ruleActions():"when "+a.getTreeAsString()+" then "+a.ruleActions()}}(this)),this.pageTitle=ko.computed(function(a){return function(){return"add"===a.action()?__("Add new rule"):__("Edit rule")}}(this)),pimatic.autoFillId(this.ruleName,this.ruleId,this.action),this.conditionInput=new d(this)}return a.prototype.autocompleteAjax=null,a.prototype.autocompleEnabled=!0,a.prototype.action=ko.observable("add"),a.prototype.ruleId=ko.observable(""),a.prototype.ruleName=ko.observable(""),a.prototype.ruleCondition=ko.observable(""),a.prototype.ruleActions=ko.observable(""),a.prototype.ruleEnabled=ko.observable(!0),a.prototype.ruleLogging=ko.observable(!0),a.prototype.tree=ko.observable(null),a.prototype.editMode=ko.observable("text"),a.prototype.resetFields=function(){return this.ruleId(""),this.ruleName(""),this.ruleCondition(""),this.ruleActions(""),this.ruleEnabled(!0),this.ruleLogging(!0)},a.prototype.addCondition=function(){return this.conditionInput.showEmpty(null)},a.prototype.editPredicate=function(a){return this.conditionInput.editPredicate(a)},a.prototype.addAnd=function(a){return this.addBinaryOp("and",a)},a.prototype.addOr=function(a){return this.addBinaryOp("or",a)},a.prototype.addBinaryOp=function(a,b){var c;return c={type:a,left:b,right:null},null!=b.parent?(b.parent.left===b?b.parent.left=c:b.parent.right=c,c.parent=b.parent,b.parent=c,this.tree.valueHasMutated()):(b.parent=c,this.tree(c)),this.conditionInput.showEmpty(c)},a.prototype.onSubmit=function(){var a;return pimatic.isValidId(this.ruleId())?(a={ruleId:this.ruleId(),rule:{ruleString:this.ruleAsText(),active:this.ruleEnabled(),name:this.ruleName(),logging:this.ruleLogging()}},function(){switch(this.action()){case"add":return pimatic.client.rest.addRuleByString(a);case"update":return pimatic.client.rest.updateRuleByString(a);default:throw new Error("Illegal rule action: "+this.action())}}.call(this).done(function(a){return a.success?$.mobile.changePage("#rules-page",{transition:"slide",reverse:!0}):alert(a.error)}).fail(ajaxAlertFail),!1):void alert(__(pimatic.invalidIdMessage))},a.prototype.onRemove=function(){var a;return a=confirm(__("Do you really want to delete the %s rule?",this.ruleName())),a&&pimatic.client.rest.removeRule({ruleId:this.ruleId()}).done(function(a){return a.success?$.mobile.changePage("#rules-page",{transition:"slide",reverse:!0}):alert(a.error)}).fail(ajaxAlertFail),!1},a.prototype.onCopy=function(){var a,b,c,d;return c=this.ruleId(),d=this.ruleName(),this.action("add"),null!=(a=d.match(/.*?([0-9]+)$/))?(b=a[1],this.ruleName(d.substring(0,d.length-b.length-1)+(parseInt(b,10)+1))):this.ruleName(d+" 2"),null!=(a=c.match(/.*?([0-9]+)$/))?(b=a[1],this.ruleId(c.substring(0,c.length-b.length-1)+(parseInt(b,10)+1))):this.ruleId(c+"-2")},a.prototype.predicateToString=function(a){var b;return b=a.justTrigger?"trigger: ":"",b+=a.token,null!=a["for"]&&(b+=" for "+a["for"].token),b},a.prototype.getTreeAsString=function(){var a,b;return b=this.tree(),null==b?"":(a=function(b){return function(c,d){var e,f;if(null==c)return"";switch(c.type){case"predicate":return b.predicateToString(c.predicate);default:return e=""+a(c.left,c)+" "+c.type+" "+a(c.right,c),f=null!=d&&d.type!==c.type,f?"["+e+"]":e}}}(this))(b)},a.prototype.setTextMode=function(){return this.ruleCondition(this.getTreeAsString()),this.editMode("text"),this.saveEditMode("text")},a.prototype.setGuiMode=function(){var a;return a=function(b,c){return b.parent=c,null!=b.left&&a(b.left,b),null!=b.right&&a(b.right,b),b},pimatic.client.rest.getRuleConditionHints({conditionInput:this.ruleCondition()},{global:!0}).done(function(b){return function(c){return c.success?0===c.hints.errors.length?(null!=c.hints.tree?b.tree(a(c.hints.tree)):b.tree(null),b.editMode("gui"),b.saveEditMode("gui")):swal("Oops...",__(c.hints.errors[0]),"error"):void 0}}(this)).fail(ajaxAlertFail)},a.prototype.saveEditMode=function(a){var b;return b=pimatic.storage.get("pimatic.editRule")||{},b.editMode=a,pimatic.storage.set("pimatic.editRule",b)},a}();try{pimatic.pages.editRule=new e}catch(g){f=g,TraceKit.report(f)}}}),$(document).on("pagecreate","#edit-rule-page",function(a){var b,c,d,e;try{return ko.applyBindings(pimatic.pages.editRule,$("#edit-rule-page")[0]),b=function(a,b){var c;return c=this.ac.getCommonPart(a,b),a.substring(0,a.length-c.length)+b},c=function(a){var b,c;return b=this.ac.getCommonPart(this.lastTerm,a),c=a.substring(b.length,a.length),"<strong>"+b+"</strong>"+c},e=pimatic.pages.editRule,$("#edit-rule-condition").textcomplete([{match:/^(.*)$/,search:function(a,b){var c,d;return null!=(d=e.autocompleteAjax)&&d.abort(),c={autocomplete:[],format:[]},pimatic.pages.editRule.autocompleEnabled?e.autocompleteAjax=pimatic.client.rest.getRuleConditionHints({conditionInput:a},{global:!1}).done(function(d){return function(e){var f,g;return c.autocomplete=(null!=(f=e.hints)?f.autocomplete:void 0)||[],c.format=(null!=(g=e.hints)?g.format:void 0)||[],e.error&&console.log(e.error),d.lastTerm=a,b(c)}}(this)).fail(function(a){return function(){return b(c)}}(this)):b(c)},index:1,replace:function(a,c){var d;return d=b.call(this,a,c),e.ruleCondition(d),d},change:function(a){return e.ruleCondition(a)},template:c}]),$("#edit-rule-actions").textcomplete([{match:/^(.*)$/,search:function(a,b){var c,d;return c={autocomplete:[],format:[]},pimatic.pages.editRule.autocompleEnabled?(null!=(d=e.autocompleteAjax)&&d.abort(),e.autocompleteAjax=pimatic.client.rest.getRuleActionsHints({actionsInput:a},{global:!1}).done(function(d){return function(e){var f,g;return c.autocomplete=(null!=(f=e.hints)?f.autocomplete:void 0)||[],c.format=(null!=(g=e.hints)?g.format:void 0)||[],null!=e.message&&e.message.length>0&&pimatic.showToast(e.message[0]),e.error&&console.log(e.error),d.lastTerm=a,b(c)}}(this)).fail(function(a){return function(){return b(c)}}(this))):b(c)},index:1,replace:function(a,c){var d;return d=b.call(this,a,c),e.ruleActions(d),d},change:function(a){return e.ruleActions(a)},template:c}])}catch(f){return d=f,TraceKit.report(d)}}),$(document).on("pagebeforehide","#edit-rule-page",function(a){var b,c;try{return null!=(c=pimatic.pages.editRule.autocompleteAjax)?c.abort():void 0}catch(d){return b=d,TraceKit.report(b)}}),$(document).on("pagebeforeshow","#edit-rule-page",function(a){var b,c,d,e,f,g;switch(b=pimatic.storage.get("pimatic.editRule")||{},c=pimatic.pages.editRule,e=jQuery.mobile.pageParams,jQuery.mobile.pageParams={},null!=e?(b.params={action:e.action,ruleId:null!=(g=e.rule)?g.id:void 0},pimatic.storage.set("pimatic.editRule",b)):null!=b.params&&(e={action:b.params.action,rule:pimatic.getRuleById(b.params.ruleId)},null==e.rule&&(e.action="add")),"update"===(null!=e?e.action:void 0)?(f=e.rule,c.action("update"),c.ruleId(f.id),c.ruleName(f.name()),c.ruleCondition(f.conditionToken()),c.ruleActions(f.actionsToken()),c.ruleEnabled(f.active()),c.ruleLogging(f.logging())):(c.resetFields(),c.action("add"),c.ruleEnabled(!0)),d=b.editMode||"gui"){case"gui":c.setGuiMode();break;case"text":c.editMode("text")}})}).call(this);