(function(){var a,b=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};a=pimatic.tryCatch,$(document).on("pagecreate","#log",a(function(){var c,d,e;c=function(){function c(){this.updateFromJs([]),this.displayedMessages=ko.computed(function(a){return function(){var c,d,e,f,g;return c=a.chosenLevels(),d=a.chosenTag(),g=a.messages(),e=function(){var a,e,h,i;for(i=[],a=0,e=g.length;e>a;a++)f=g[a],h=f.level,b.call(c,h)>=0&&("All"===d||b.call(f.tags,d)>=0)&&i.push(f);return i}()}}(this)).extend({rateLimit:{timeout:10,method:"notifyAtFixedRate"}}),ko.computed(function(a){return function(){return a.chosenLevels(),a.chosenTag(),a.loadMessages()}}(this)),this.messageCountText=ko.computed(function(a){return function(){var b;return b=a.messageCount(),null!=b?__("Showing %s of %s Messages",a.displayedMessages().length,b):""}}(this)),this.updateListView=ko.computed(function(a){return function(){return a.displayedMessages(),$("#log-messages").listview("refresh")}}(this)),pimatic.socket.on("messageLogged",a(function(a){return function(b){return a.messages.unshift({tags:b.meta.tags,level:b.level,text:b.msg,time:b.meta.timestamp})}}(this)))}return c.mapping={$default:"ignore",messages:{$key:"id",$itemOptions:{$handler:"copy"}}},c.prototype.chosenLevels=ko.observableArray(["info","warn","error"]),c.prototype.tags=ko.observableArray(["All","pimatic"]),c.prototype.chosenTag=ko.observableArray([]),c.prototype.messageCount=ko.observable(null),c.prototype.updateFromJs=function(a){return ko.mapper.fromJS({messages:a},c.mapping,this)},c.prototype.timestampToDateTime=function(a){var b,c,d;return d=function(){return function(a){return 10>a?"0"+a:""+a}}(this),b=new Date(a),c=d(b.getDate())+"."+d(b.getMonth()+1)+"."+b.getFullYear(),a=d(b.getHours())+":"+d(b.getMinutes())+":"+d(b.getSeconds()),{date:c,time:a}},c.prototype.timeToShow=function(a){var b,c,d,e,f,g,h,i,j;return a=a(),d=this.displayedMessages(),0===a?(f=d[a],null==f?"":(e=this.timestampToDateTime(null!=f?f.time:void 0),""+e.date+" "+e.time)):(i=[d[a-1],d[a]],g=i[0],h=i[1],j=[this.timestampToDateTime(g.time),this.timestampToDateTime(h.time)],b=j[0],c=j[1],c.date===b.date?c.time:""+c.date+" "+c.time)},c.prototype.loadMessages=function(){var c;return c=function(c){return function(){var d;if(null==c.loadMessagesAjax)return pimatic.loading("loading message","show",{text:__("Loading Messages")}),d={level:c.chosenLevels(),limit:100},"All"!==c.chosenTag()&&(d.tags=c.chosenTag()),pimatic.client.rest.queryMessages({criteria:d},{timeout:6e4,global:!1}).always(function(){return pimatic.loading("loading message","hide")}).done(a(function(a){var d,e,f,g,h,i,j,k;if(c.loadMessagesAjax=null,a.success)for(c.updateFromJs(a.messages),j=a.messages,f=0,h=j.length;h>f;f++)for(d=j[f],k=d.tags,g=0,i=k.length;i>g;g++)e=k[g],b.call(c.tags(),e)<0&&c.tags.push(e)})).fail(ajaxAlertFail)}}(this),null==this.loadMessagesAjax?c():this.loadMessagesAjax.done(function(){return function(){return c()}}(this))},c.prototype.loadMessagesMeta=function(){return pimatic.client.rest.queryMessagesTags({criteria:{}}).done(a(function(a){return function(c){var d,e,f,g,h;if(c.success){for(g=c.tags,h=[],e=0,f=g.length;f>e;e++)d=g[e],h.push(b.call(a.tags(),d)<0?a.tags.push(d):void 0);return h}}}(this))),pimatic.client.rest.queryMessagesCount({criteria:{}}).done(a(function(a){return function(b){return b.success?a.messageCount(b.count):void 0}}(this)))},c}();try{pimatic.pages.log=e=new c,pimatic.socket.on("log",a(function(a){var b;return b=e.messageCount(),null!=b&&e.messageCount(b+1),e.messages.unshift(a)})),$("#log").on("click","#clear-log",a(function(){var b;return b=e.messages[e.messages.length-1],pimatic.client.rest.deleteMessages({criteria:{}}).done(a(function(){return e.messages.removeAll(),pimatic.pages.index.errorCount(0),e.messageCount(0)})).fail(ajaxAlertFail)})),ko.applyBindings(e,$("#log")[0])}catch(f){d=f,TraceKit.report(d)}})),$(document).on("pagebeforeshow","#log",a(function(){var a,b;try{return b=pimatic.pages.log,null!=jQuery.mobile.pageParams&&(jQuery.mobile.pageParams.selectErrors&&b.chosenLevels(["error"]),jQuery.mobile.pageParams=null),b.loadMessages(),b.loadMessagesMeta()}catch(c){return a=c,TraceKit.report(a)}}))}).call(this);